---
import Header from '../components/common/Header.astro';
import Layout from '../layouts/Layout.astro';
import Footer from '../components/common/Footer.astro';
import FooterMobile from "../components/common/FooterMobile.astro";
import TopBanner from '@/components/BorrowVCL/pagebanner.astro';
import VCLTabs from '@/components/BorrowVCL/VCLTabs.astro';
import ContactButton from '../components/common/HomeGetInTouch.jsx';


import { GRAPHQL } from "@/config/graphql";

const query = `
query {
  page(id: "borrow-vcl", idType: URI) {
    title
    borrowvcl {
      bannerTitle
      bannerImage {
        node {
          sourceUrl
        }
      }
      corporateTitle
      corporateDescription
      financialTitle
      financialDescription
    }
  }

  financialProducts(first: 100) {
    nodes {
      title
      slug
      description
      tenor
      segments {
        nodes {
          slug
        }
      }
      borrowContexts {
        nodes {
          slug
        }
      }
    }
  }
}


`;

const res = await fetch(GRAPHQL, {
  method: "POST",
  headers: { "Content-Type": "application/json" },
  body: JSON.stringify({ query }),
});

const data = await res.json();
const pageData = data?.data?.page?.borrowvcl;

if (!pageData) {
  throw new Error("Borrow VCL page data not found");
}

const bannerTitle = pageData.bannerTitle;
const bannerImage = pageData.bannerImage?.node?.sourceUrl;
const corporateTitle = pageData.corporateTitle;
const corporateDescription = pageData.corporateDescription;
const financialTitle = pageData.financialTitle;
const financialDescription = pageData.financialDescription;



if (!data?.data?.financialProducts?.nodes) {
  throw new Error("Financial products not found");
}

const allProducts = data.data.financialProducts.nodes;

const filteredProducts = allProducts.filter(item =>
  item.borrowContexts?.nodes?.some(ctx =>
    ctx.slug === "borrow-from-vivriti-capital"
  )
);

const corporates = filteredProducts.filter(item =>
  item.segments?.nodes?.some(seg =>
    seg.slug === "corporates"
  )
);

const financials = filteredProducts.filter(item =>
  item.segments?.nodes?.some(seg =>
    seg.slug === "financial-institutions"
  )
);
---
<Layout>
<ContactButton label={"Start Your Financing Conversation"} href={"/contact-us/?segment=borrow#leadgen"} width={"400"} client:load />
<Header />
<TopBanner
  heading={bannerTitle}
   
    image={bannerImage} />
<VCLTabs
  corporates={corporates}
  corporateTitle={corporateTitle}
   corporateDes={corporateDescription}
   financialTitle={financialTitle}
   financialDes={financialDescription}
  financials={financials}
/>
<Footer />
<FooterMobile/>
</Layout>

<style>
    .getintouch-fix{
        width: 330px!important;
    }
</style>