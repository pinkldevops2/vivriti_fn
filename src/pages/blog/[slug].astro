---
import Layout from "../../layouts/Layout.astro";
import Header from "../../components/common/Header.astro";
import Footer from "../../components/common/Footer.astro";
import FooterMobile from "../../components/common/FooterMobile.astro";
import { GRAPHQL } from "../../config/graphql.js";

/* -------------------------------------------
   REQUIRED FOR STATIC BUILD (AWS AMPLIFY)
-------------------------------------------- */
export async function getStaticPaths() {
  const res = await fetch(GRAPHQL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      query: `
        query AllPostSlugs {
          posts(first: 1000) {
            nodes {
              slug
            }
          }
        }
      `,
    }),
  });

  const json = await res.json();

  if (!json?.data?.posts?.nodes) {
    throw new Error("Failed to fetch blog slugs from WP Engine");
  }

  return json.data.posts.nodes.map((post) => ({
    params: { slug: post.slug },
  }));
}

/* -------------------------------------------
   PAGE DATA
-------------------------------------------- */
const { slug } = Astro.params;

let item = null;
let related = [];
let fetchError = null;

try {
  const singleQuery = `
    query SinglePostBySlug($slug: ID!) {
      post(id: $slug, idType: SLUG) {
        slug
        title
        date
        content
        excerpt
        featuredImage {
          node {
            sourceUrl
          }
        }
        blog {
          description
          uploadPdf {
            node {
              mediaItemUrl
              mimeType
            }
          }
        }
      }
    }
  `;

  const allQuery = `
    query AllPosts {
      posts(first: 100) {
        nodes {
          slug
          title
          date
          featuredImage {
            node {
              sourceUrl
            }
          }
          blog {
            description
            uploadPdf {
              node {
                mediaItemUrl
                mimeType
              }
            }
          }
        }
      }
    }
  `;

  const resSingle = await fetch(GRAPHQL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query: singleQuery, variables: { slug } }),
  });

  const jsonSingle = await resSingle.json();
  if (jsonSingle.errors) {
    throw new Error(jsonSingle.errors.map(e => e.message).join(", "));
  }

  item = jsonSingle.data.post || null;

  const resAll = await fetch(GRAPHQL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ query: allQuery }),
  });

  const jsonAll = await resAll.json();
  if (jsonAll.errors) {
    throw new Error(jsonAll.errors.map(e => e.message).join(", "));
  }

  const allPosts = jsonAll.data.posts?.nodes || [];
  related = allPosts.filter(n => n.slug !== item?.slug).slice(0, 3);

} catch (err) {
  fetchError = err;
}
---

<Layout>
  <Header />

  <main class="container mx-auto px-4 lg:px-8 xl:px-4 pt-15 blog_details">
    {fetchError && (
      <p class="text-red-500 text-center mb-6">{fetchError.message}</p>
    )}

    {item ? (
      <>
        <p class="mb-4 underline">
          <a href="/blog/" class="text-[16px]">Go Back</a>
        </p>

        <h1 class="gradient-text text-[28px] md:text-[35px] font-heading leading-[120%] mb-4">
          {item.title}
        </h1>

        {item.blog?.description ? (
          <div class="text-gray-700 leading-relaxed mb-8">
            <div class="content" set:html={item.blog.description}></div>
          </div>
        ) : (
          <p class="text-gray-500 mb-8">No description available.</p>
        )}

        {item.blog?.uploadPdf?.node?.mediaItemUrl && (
          <div class="mb-6">
            <a
              href={item.blog.uploadPdf.node.mediaItemUrl}
              target="_blank"
              class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition"
            >
              Download PDF
            </a>
          </div>
        )}

        
      </>
    ) : (
      <p class="text-red-500 text-center">Blog item not found.</p>
    )}
  </main>

  {/* RELATED CONTENT */}
  <section class="container mx-auto px-4 lg:px-8 xl:px-4 pt-5 pb-15">
    <h2 class="text-[28px] md:text-[35px] font-heading leading-[120%] mb-8">
      Related Content
    </h2>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      {related.length > 0 ? (
        related.map(rel => (
          <a href={`/blog/${rel.slug}`} class="block group tabactive">
            <div class="h-48 overflow-hidden mb-4">
              <img
                src={rel.featuredImage?.node?.sourceUrl || "/placeholder.jpg"}
                class="w-full h-full object-cover group-hover:scale-105 transition"
              />
            </div>

            <p class="text-[14px] font-medium mb-1 gradient-text">Blogs</p>

            <h3 class="font-medium text-[18px] md:text-[23px] leading-[120%] my-4">
              {rel.title}
            </h3>

            <div class="flex justify-between items-center">
              <p class="text-[14px]">
                {new Date(rel.date).toLocaleDateString("en-GB", {
                  day: "numeric",
                  month: "short",
                  year: "numeric",
                })}
              </p>

              <p class="font-semibold underline text-[14px]">READ MORE</p>
            </div>
          </a>
        ))
      ) : (
        <p class="text-gray-500">No related content available.</p>
      )}
    </div>
  </section>

  <Footer />
  <FooterMobile />
</Layout>
